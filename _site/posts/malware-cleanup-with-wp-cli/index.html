<!DOCTYPE html>
<html lang="en-US">

<head prefix="og: http://ogp.me/ns#">
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="application-name" content="Sharif Mohammad Eunus" />
    <meta name="apple-mobile-web-app-status-bar-style" content="#fff" />
    <meta name="apple-mobile-web-app-title" content="Sharif Mohammad Eunus" />
    <title> Malware Cleanup with WP CLI - Sharif Mohammad Eunus </title>
    <link rel="alternate" href="/posts/malware-cleanup-with-wp-cli/" hreflang="en-US" />
    <link rel="canonical" href="/posts/malware-cleanup-with-wp-cli/" />
    <meta name="description"
        content="WP CLI enables the management of WordPress admin actions through the command line. This tool is particularly useful for performing actions that are typically done from the admin area, especially th..." />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    <meta property="fb:app_id" content="" />
    <meta property="og:site_name" content="Managing WordPress with WP CLI | Sharif Mohammad Eunus" />
    <meta property="og:title" content="Managing WordPress with WP CLI | Sharif Mohammad Eunus" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="/posts/malware-cleanup-with-wp-cli/" />
    <meta property="og:description"
        content="WP CLI enables the management of WordPress admin actions through the command line. This tool is particularly useful for performing actions that are typically done from the admin area, especially th..." />
    <meta property="og:image" content="/posts/malware-cleanup-with-wp-cli/shell_evolution.png" />
    <meta property="og:image:width" content="640" />
    <meta property="og:image:height" content="640" />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Managing WordPress with WP CLI | twitter_username" />
    <meta name="twitter:url" content="/posts/malware-cleanup-with-wp-cli/" />
    <meta name="twitter:site" content="@twitter_username" />
    <meta name="twitter:creator" content="@twitter_username" />
    <meta name="twitter:description"
        content="WP CLI enables the management of WordPress admin actions through the command line. This tool is particularly useful for performing actions that are typically done from the admin area, especially th..." />
    <meta name="twitter:image" content="/posts/malware-cleanup-with-wp-cli/shell_evolution.png" />
    <link type="application/atom+xml" rel="alternate" href="/feed.xml" title="Sharif Mohammad Eunus" />
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicons/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicons/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicons/favicon-16x16.png" />
    <link rel="manifest" href="/assets/favicons/site.webmanifest" />
    <link rel="mask-icon" href="/assets/favicons/safari-pinned-tab.svg" color="#5bbad5" />
    <meta name="apple-mobile-web-app-title" content="Jekyll Klise" />
    <meta name="application-name" content="Jekyll Klise" />
    <meta name="msapplication-TileColor" content="#da532c" />
    <meta name="theme-color" content="#2c2c2c" />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism-themes/1.9.0/prism-nord.min.css">
    <link rel="stylesheet" href="/main.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
</head>

<body data-theme="dark" class="notransition">
    <script> const body = document.body; const data = body.getAttribute("data-theme"); const initTheme = (state) => { if (state === "dark") { body.setAttribute("data-theme", "dark"); } else if (state === "light") { body.removeAttribute("data-theme"); } else { localStorage.setItem("theme", data); } }; initTheme(localStorage.getItem("theme")); setTimeout(() => body.classList.remove("notransition"), 75); </script>
    <div class="navbar" role="navigation">
        <nav class="menu"> <input type="checkbox" id="menu-trigger" class="menu-trigger" /> <label for="menu-trigger">
                <span class="menu-icon"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                        viewBox="0 0 512 512">
                        <path d="M64,384H448V341.33H64Zm0-106.67H448V234.67H64ZM64,128v42.67H448V128Z" />
                    </svg> </span> </label> <a id="mode"> <svg class="mode-sunny" xmlns="http://www.w3.org/2000/svg"
                    width="24" height="24" viewBox="0 0 512 512">
                    <title>LIGHT</title>
                    <line x1="256" y1="48" x2="256" y2="96"
                        style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" />
                    <line x1="256" y1="416" x2="256" y2="464"
                        style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" />
                    <line x1="403.08" y1="108.92" x2="369.14" y2="142.86"
                        style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" />
                    <line x1="142.86" y1="369.14" x2="108.92" y2="403.08"
                        style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" />
                    <line x1="464" y1="256" x2="416" y2="256"
                        style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" />
                    <line x1="96" y1="256" x2="48" y2="256"
                        style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" />
                    <line x1="403.08" y1="403.08" x2="369.14" y2="369.14"
                        style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" />
                    <line x1="142.86" y1="142.86" x2="108.92" y2="108.92"
                        style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" />
                    <circle cx="256" cy="256" r="80"
                        style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" />
                </svg> <svg class="mode-moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                    viewBox="0 0 512 512">
                    <title>DARK</title>
                    <line x1="256" y1="48" x2="256" y2="96"
                        style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" />
                    <line x1="256" y1="416" x2="256" y2="464"
                        style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" />
                    <line x1="403.08" y1="108.92" x2="369.14" y2="142.86"
                        style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" />
                    <line x1="142.86" y1="369.14" x2="108.92" y2="403.08"
                        style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" />
                    <line x1="464" y1="256" x2="416" y2="256"
                        style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" />
                    <line x1="96" y1="256" x2="48" y2="256"
                        style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" />
                    <line x1="403.08" y1="403.08" x2="369.14" y2="369.14"
                        style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" />
                    <line x1="142.86" y1="142.86" x2="108.92" y2="108.92"
                        style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" />
                    <circle cx="256" cy="256" r="80"
                        style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" />
                </svg> </a>
            <div class="trigger">
                <div class="trigger-container"><a class="menu-link" href="/">home</a><a class="menu-link"
                        href="/about/">about</a><a class="menu-link" href="https://github.com/shariffff" target="_blank"
                        rel="noopener">github</a></div>
            </div>
        </nav>
    </div>
    <div class="wrapper post">
        <main class="page-content" aria-label="Content">
            <article itemscope itemtype="https://schema.org/BlogPosting">
                <header class="header">
                    <div class="tags">
                        <!-- <span itemprop="keywords"> <a class="tag" href="/tags/#cli">CLI</a> </span> -->
                    </div>
                    <h1 class="header-title" itemprop="headline">Malware Cleanup with WP CLI</h1>
                    <div class="post-meta"> <time datetime="Tue Jan 10 2023 06:00:00 GMT+0600 (Bangladesh Standard Time)" itemprop="datePublished"> Jan 25,
                            2020 </time> <span itemprop="author" itemscope itemtype="https://schema.org/Person"> <span
                                itemprop="name">Sharif Mohammad Eunus</span> </span> <time hidden
                            datetime="2020-02-02T16:49:47+07:00" itemprop="dateModified"> Jan 25, 2020 </time> <span
                            hidden itemprop="publisher" itemtype="Person">Sharif Mohammad Eunus</span> </div>
                </header>
                <div class="page-content" itemprop="articleBody">
                    <p>A WordPress site can become compromised for various reasons, including but not limited to: outdated plugins, themes, or the core. Additionally, being on a shared hosting platform can increase the risk of infection from other websites.</p>
<p>WordPress CLI comes in handy while cleaning up a site. To begin, it is important to confirm that the core WordPress and plugins have valid checksums and that the theme files have been cleared.</p>
<blockquote>
<p>Make sure to take a backup before the cleanup.</p>
</blockquote>
<p>We can break down the process like this:</p>
<ol>
<li>Replace WordPress core files if needed.</li>
<li>Investigate wp-config file.</li>
<li>Verify plugin checksums.</li>
<li>Check themes.</li>
<li>Others</li>
</ol>
<h3>Replace WordPress core</h3>
<p>The very first step would be to replace the WordPress core files. To do that run the command:</p>
<pre class="language-bash"><code class="language-bash">
wp core download <span class="token parameter variable">--force</span> --skip-content
</code></pre>
<p>I’ve explained in depth about replacing core files here: <a href="#">Replace WordPress core with WP CLI</a></p>
<h3>Investigate the wp-config file</h3>
<p>Check if the <code>wp-config.php</code> file contains any suspicious code. Two common scenarios are either you’ll notice arbitrary code at the beginning or additional <code>require</code> statements at the bottom of the file. The file should end like this:</p>
<pre class="language-php"><code class="language-php"><span class="token comment">/** Sets up WordPress vars and included files. */</span>
<span class="token keyword">require_once</span> <span class="token constant">ABSPATH</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'wp-settings.php'</span><span class="token punctuation">;</span></code></pre>
<p>If you notice any additional <code>require</code>/<code>require_once</code>/<code>@require</code> statement at the bottom, either it’s from the host if you are on a managed host, or it’s from the malware. Delete the additional require statement if it’s not from the host.</p>
<h3>Verify plugin checksums</h3>
<p>Like WP core, there is a way to verify plugin checksums if the plugin exists on wordpress.org. To verify checksums for all plugins, we can run the command.</p>
<pre class="language-bash"><code class="language-bash">wp plugin verify-checksums <span class="token parameter variable">--all</span></code></pre>
<p>If plugin checksums fail, we’ll see that in the output. We have to reinstall those mentioned plugins.</p>
<p>We need to use the string in the <code>plugin_name</code> column to reinstall the plugins.</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># Re-install single plugin</span>
wp plugin <span class="token function">install</span> contact-form-7 <span class="token parameter variable">--force</span>

<span class="token comment"># Re-install all the plugins</span>
wp plugin list <span class="token parameter variable">--field</span><span class="token operator">=</span>name <span class="token operator">|</span> <span class="token function">xargs</span> wp plugin <span class="token function">install</span> <span class="token parameter variable">--force</span>

<span class="token comment"># Re-install faster and avoid PHP errors</span>
wp plugin list <span class="token parameter variable">--field</span><span class="token operator">=</span>name --skip-plugins --skip-themes <span class="token operator">|</span> <span class="token function">xargs</span> wp plugin <span class="token function">install</span> <span class="token parameter variable">--force</span> --skip-plugins --skip-themes</code></pre>
<p>For plugins that are not available in wordpress.org – CLI will return a warning message like: <code>Warning: [plugin-name]: Plugin not found</code></p>
<p>Re-install those plugins manually by uploading a zip or from the WordPress admin area. To install a zipped plugin from CLI <code>wp plugin install --force path-to-the-file/premium-plugin.zip</code></p>
<h3>Check themes</h3>
<p>Like plugins and WordPress core, there is no way to verify the checksums for themes. Themes need to be reinstalled, and codes need to be re-checked for child themes. We can use <code>wp theme list</code> to check the installed themes. The reinstallation procedure is as same as the plugins.</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># Re-install single theme</span>
wp theme <span class="token function">install</span> theme-name <span class="token parameter variable">--force</span>

<span class="token comment"># Re-install all the plugins</span>
wp theme list <span class="token parameter variable">--field</span><span class="token operator">=</span>name <span class="token operator">|</span> <span class="token function">xargs</span> wp theme <span class="token function">install</span> <span class="token parameter variable">--force</span>

<span class="token comment"># Re-install faster and avoid PHP errors</span>
wp theme list <span class="token parameter variable">--field</span><span class="token operator">=</span>name --skip-plugins --skip-themes <span class="token operator">|</span> <span class="token function">xargs</span> wp thene <span class="token function">install</span> <span class="token parameter variable">--force</span> --skip-plugins --skip-themes</code></pre>
<p>Reinstall premium themes. And for child themes, check the header/footer/functions files manually to find and remove suspicious code.</p>
<h3>Others</h3>
<p>Use <code>https://sitecheck.sucuri.net/</code> to scan the site. Also, Use a security plugin like Defender Security or Wordfence Security. They have scan features that can scan the installed plugins, themes, and report vulnerabilities or any suspicious code.</p>

                </div>
            </article>
        </main>
        <!-- <nav class="post-nav"> <a class="post-nav-item post-nav-prev" href="/">
                <div class="nav-arrow">Previous</div> <span class="post-title"></span>
            </a> </nav> -->
        <footer class="footer"> <a class="footer_item" href="/feed.xml">rss</a> <span class="footer_item">&copy;
                2024</span> </footer>
        <script>
            (() => {
                // Theme switch
                const body = document.body;
                const lamp = document.getElementById("mode");

                const toggleTheme = (state) => {
                    if (state === "dark") {
                        localStorage.setItem("theme", "light");
                        body.removeAttribute("data-theme");
                    } else if (state === "light") {
                        localStorage.setItem("theme", "dark");
                        body.setAttribute("data-theme", "dark");
                    } else {
                        initTheme(state);
                    }
                };

                lamp.addEventListener("click", () =>
                    toggleTheme(localStorage.getItem("theme"))
                );

                // Blur the content when the menu is open
                const cbox = document.getElementById("menu-trigger");

                cbox.addEventListener("change", function () {
                    const area = document.querySelector(".wrapper");
                    this.checked
                        ? area.classList.add("blurry")
                        : area.classList.remove("blurry");
                });
            })();

        </script>
    </div>
</body>

</html>