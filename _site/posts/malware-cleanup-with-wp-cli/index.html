<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="UTF-8"/>
        <meta http-equiv="X-UA-Compatible" content="ie=edge"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <title>
            Malware Cleanup with WP CLI - Sharif Mohammad Eunus
        </title>
        <link rel="stylesheet" href="/main.css">
        <link rel="preconnect" href="https://fonts.googleapis.com">
    </head>
    <body data-theme="dark" class="notransition">
        <script>
            const body = document.body;
            const data = body.getAttribute("data-theme");
            const initTheme = (state) => {
                if (state === "dark") {
                    body.setAttribute("data-theme", "dark");
                } else if (state === "light") {
                    body.removeAttribute("data-theme");
                } else {
                    localStorage.setItem("theme", data);
                }
            };
            initTheme(localStorage.getItem("theme"));
            setTimeout(() => body.classList.remove("notransition"), 75);
        </script>
        <div class="navbar" role="navigation">
            <nav class="menu">
                <input type="checkbox" id="menu-trigger" class="menu-trigger"/>
                <label for="menu-trigger">
                    <span class="menu-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 512 512">
                            <path d="M64,384H448V341.33H64Zm0-106.67H448V234.67H64ZM64,128v42.67H448V128Z"/>
                        </svg>
                    </span>
                </label>
                <a id="mode">
                    <svg class="mode-sunny" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 512 512">
                        <title>LIGHT</title>
                        <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"/>
                        <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"/>
                        <line
                            x1="403.08"
                            y1="108.92"
                            x2="369.14"
                            y2="142.86"
                            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"/>
                        <line
                            x1="142.86"
                            y1="369.14"
                            x2="108.92"
                            y2="403.08"
                            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"/>
                        <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"/>
                        <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"/>
                        <line
                            x1="403.08"
                            y1="403.08"
                            x2="369.14"
                            y2="369.14"
                            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"/>
                        <line
                            x1="142.86"
                            y1="142.86"
                            x2="108.92"
                            y2="108.92"
                            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"/>
                        <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"/>
                    </svg>
                    <svg class="mode-moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 512 512">
                        <title>DARK</title>
                        <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"/>
                        <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"/>
                        <line
                            x1="403.08"
                            y1="108.92"
                            x2="369.14"
                            y2="142.86"
                            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"/>
                        <line
                            x1="142.86"
                            y1="369.14"
                            x2="108.92"
                            y2="403.08"
                            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"/>
                        <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"/>
                        <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"/>
                        <line
                            x1="403.08"
                            y1="403.08"
                            x2="369.14"
                            y2="369.14"
                            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"/>
                        <line
                            x1="142.86"
                            y1="142.86"
                            x2="108.92"
                            y2="108.92"
                            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"/>
                        <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"/>
                    </svg>
                </a>
                <div class="trigger">
                    <div class="trigger-container">
                        <a class="menu-link" href="/">home</a>
                        <a class="menu-link" href="/about/">about</a>
                        <a class="menu-link" href="https://github.com/shariffff" target="_blank" rel="noopener">github</a>
                    </div>
                </div>
            </nav>
        </div>
    </body>
</html>
<div class="wrapper post">
    <main class="page-content" aria-label="Content">
        <article itemscope itemtype="https://schema.org/BlogPosting">
            <header class="header">
                <div
                    class="tags"><!-- <span itemprop="keywords"> <a class="tag" href="/tags/#cli">CLI</a> </span> -->
                </div>
                <h1 class="header-title" itemprop="headline">Malware Cleanup with WP CLI</h1>
                <div class="post-meta">
                    <time datetime="2023-01-10" itemprop="datePublished">
                        10 Jan 2023
                    </time>
                    <span itemprop="author" itemscope itemtype="https://schema.org/Person">
                        <span itemprop="name">Sharif Mohammad Eunus</span>
                    </span>
                    <time hidden datetime="2023-01-10" itemprop="dateModified">
                        10 Jan 2023
                    </time>
                    <span hidden itemprop="publisher" itemtype="Person">Sharif Mohammad Eunus</span>
                </div>
            </header>
            <div class="page-content" itemprop="articleBody">
                <p>A WordPress site can become compromised for various reasons, including but not limited to: outdated plugins, themes, or the core. Additionally, being on a shared hosting platform can increase the risk of infection from other websites.</p>
<p>WordPress CLI comes in handy while cleaning up a site. To begin, it is important to confirm that the core WordPress and plugins have valid checksums and that the theme files have been cleared.</p>
<blockquote>
<p>Make sure to take a backup before the cleanup.</p>
</blockquote>
<p>We can break down the process like this:</p>
<ol>
<li>Replace WordPress core files if needed.</li>
<li>Investigate wp-config file.</li>
<li>Verify plugin checksums.</li>
<li>Check themes.</li>
<li>Others</li>
</ol>
<h3>Replace WordPress core</h3>
<p>The very first step would be to replace the WordPress core files. To do that run the command:</p>
<pre class="shiki aurora-x" style="background-color:#07090F;color:#bbbbbb" tabindex="0"><code class="language-bash"><span class="line"><span style="color:#FFCB6B">wp</span><span style="color:#C3E88D"> core</span><span style="color:#C3E88D"> download</span><span style="color:#C3E88D"> --force</span><span style="color:#C3E88D"> --skip-content</span></span></code></pre>
<p>I’ve explained in depth about replacing core files here: <a href="/posts/replace-wordpress-core-with-wp-cli/">Replace WordPress core with WP CLI</a></p>
<h3>Investigate the wp-config file</h3>
<p>Check if the <code>wp-config.php</code> file contains any suspicious code. Two common scenarios are either you’ll notice arbitrary code at the beginning or additional <code>require</code> statements at the bottom of the file. The file should end like this:</p>
<pre class="shiki aurora-x" style="background-color:#07090F;color:#bbbbbb" tabindex="0"><code class="language-php"><span class="line"><span style="color:#546E7A;font-style:italic">/** Sets up WordPress vars and included files. */</span></span>
<span class="line"><span style="color:#89DDFF">require_once</span><span style="color:#BBBBBB"> ABSPATH </span><span style="color:#C792EA">.</span><span style="color:#89DDFF"> '</span><span style="color:#C3E88D">wp-settings.php</span><span style="color:#89DDFF">'</span><span style="color:#89DDFF">;</span></span></code></pre>
<p>If you notice any additional <code>require</code>/<code>require_once</code>/<code>@require</code> statement at the bottom, either it’s from the host if you are on a managed host, or it’s from the malware. Delete the additional require statement if it’s not from the host.</p>
<h3>Verify plugin checksums</h3>
<p>Like WP core, there is a way to verify plugin checksums if the plugin exists on wordpress.org. To verify checksums for all plugins, we can run the command.</p>
<pre class="shiki aurora-x" style="background-color:#07090F;color:#bbbbbb" tabindex="0"><code class="language-bash"><span class="line"><span style="color:#FFCB6B">wp</span><span style="color:#C3E88D"> plugin</span><span style="color:#C3E88D"> verify-checksums</span><span style="color:#C3E88D"> --all</span></span></code></pre>
<p>If plugin checksums fail, we’ll see that in the output. We have to reinstall those mentioned plugins.</p>
<p>We need to use the string in the <code>plugin_name</code> column to reinstall the plugins.</p>
<pre class="shiki aurora-x" style="background-color:#07090F;color:#bbbbbb" tabindex="0"><code class="language-bash"><span class="line"><span style="color:#546E7A;font-style:italic"># Re-install single plugin</span></span>
<span class="line"><span style="color:#FFCB6B">wp</span><span style="color:#C3E88D"> plugin</span><span style="color:#C3E88D"> install</span><span style="color:#C3E88D"> contact-form-7</span><span style="color:#C3E88D"> --force</span></span>
<span class="line"></span>
<span class="line"><span style="color:#546E7A;font-style:italic"># Re-install all the plugins</span></span>
<span class="line"><span style="color:#FFCB6B">wp</span><span style="color:#C3E88D"> plugin</span><span style="color:#C3E88D"> list</span><span style="color:#C3E88D"> --field=name</span><span style="color:#C792EA"> |</span><span style="color:#FFCB6B"> xargs</span><span style="color:#C3E88D"> wp</span><span style="color:#C3E88D"> plugin</span><span style="color:#C3E88D"> install</span><span style="color:#C3E88D"> --force</span></span>
<span class="line"></span>
<span class="line"><span style="color:#546E7A;font-style:italic"># Re-install faster and avoid PHP errors</span></span>
<span class="line"><span style="color:#FFCB6B">wp</span><span style="color:#C3E88D"> plugin</span><span style="color:#C3E88D"> list</span><span style="color:#C3E88D"> --field=name</span><span style="color:#C3E88D"> --skip-plugins</span><span style="color:#C3E88D"> --skip-themes</span><span style="color:#C792EA"> |</span><span style="color:#FFCB6B"> xargs</span><span style="color:#C3E88D"> wp</span><span style="color:#C3E88D"> plugin</span><span style="color:#C3E88D"> install</span><span style="color:#C3E88D"> --force</span><span style="color:#C3E88D"> --skip-plugins</span><span style="color:#C3E88D"> --skip-themes</span></span></code></pre>
<p>For plugins that are not available in wordpress.org – CLI will return a warning message like: <code>Warning: [plugin-name]: Plugin not found</code></p>
<p>Re-install those plugins manually by uploading a zip or from the WordPress admin area. To install a zipped plugin from CLI <code>wp plugin install --force path-to-the-file/premium-plugin.zip</code></p>
<h3>Check themes</h3>
<p>Like plugins and WordPress core, there is no way to verify the checksums for themes. Themes need to be reinstalled, and codes need to be re-checked for child themes. We can use <code>wp theme list</code> to check the installed themes. The reinstallation procedure is as same as the plugins.</p>
<pre class="shiki aurora-x" style="background-color:#07090F;color:#bbbbbb" tabindex="0"><code class="language-bash"><span class="line"><span style="color:#546E7A;font-style:italic"># Re-install single theme</span></span>
<span class="line"><span style="color:#FFCB6B">wp</span><span style="color:#C3E88D"> theme</span><span style="color:#C3E88D"> install</span><span style="color:#C3E88D"> theme-name</span><span style="color:#C3E88D"> --force</span></span>
<span class="line"></span>
<span class="line"><span style="color:#546E7A;font-style:italic"># Re-install all the plugins</span></span>
<span class="line"><span style="color:#FFCB6B">wp</span><span style="color:#C3E88D"> theme</span><span style="color:#C3E88D"> list</span><span style="color:#C3E88D"> --field=name</span><span style="color:#C792EA"> |</span><span style="color:#FFCB6B"> xargs</span><span style="color:#C3E88D"> wp</span><span style="color:#C3E88D"> theme</span><span style="color:#C3E88D"> install</span><span style="color:#C3E88D"> --force</span></span>
<span class="line"></span>
<span class="line"><span style="color:#546E7A;font-style:italic"># Re-install faster and avoid PHP errors</span></span>
<span class="line"><span style="color:#FFCB6B">wp</span><span style="color:#C3E88D"> theme</span><span style="color:#C3E88D"> list</span><span style="color:#C3E88D"> --field=name</span><span style="color:#C3E88D"> --skip-plugins</span><span style="color:#C3E88D"> --skip-themes</span><span style="color:#C792EA"> |</span><span style="color:#FFCB6B"> xargs</span><span style="color:#C3E88D"> wp</span><span style="color:#C3E88D"> thene</span><span style="color:#C3E88D"> install</span><span style="color:#C3E88D"> --force</span><span style="color:#C3E88D"> --skip-plugins</span><span style="color:#C3E88D"> --skip-themes</span></span></code></pre>
<p>Reinstall premium themes. And for child themes, check the header/footer/functions files manually to find and remove suspicious code.</p>
<h3>Others</h3>
<p>Use <a href="https://sitecheck.sucuri.net/">Sucuri Scan</a> to scan the site. Also, Use a security plugin like Defender Security or Wordfence Security. They have scan features that can scan the installed plugins, themes, and report vulnerabilities or any suspicious code.</p>

            </div>
        </article>
    </main>
    <!-- <nav class="post-nav"> <a class="post-nav-item post-nav-prev" href="/">
            <div class="nav-arrow">Previous</div> <span class="post-title"></span>
        </a> </nav> -->
    <footer
    class="footer">
    
    <span class="footer_item">&copy; 2024</span>
</footer>
<script>
    (() => { // Theme switch
        const body = document.body;
        const lamp = document.getElementById("mode");
        const toggleTheme = (state) => {
            if (state === "dark") {
                localStorage.setItem("theme", "light");
                body.removeAttribute("data-theme");
            } else if (state === "light") {
                localStorage.setItem("theme", "dark");
                body.setAttribute("data-theme", "dark");
            } else {
                initTheme(state);
            }
        };
        lamp.addEventListener("click", () => toggleTheme(localStorage.getItem("theme")));
        // Blur the content when the menu is open
        const cbox = document.getElementById("menu-trigger");
        cbox.addEventListener("change", function () {
            const area = document.querySelector(".wrapper");
            this.checked
                ? area.classList.add("blurry")
                : area.classList.remove("blurry");
        });
    })();
</script></body></html>